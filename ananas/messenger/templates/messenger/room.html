{% extends "header.html" %}
{% block title %}Messagerie{%endblock%}
{%block headerlink %}<!-- CSS connexion page -->
<link rel="stylesheet" href="{{STATIC_URL}}/static/messenger/css/style.css">
{% endblock %}
{% block content %}
<main id="frame">
	{%load jsonTopy %}
	<nav id="sidepanel">
		<div id="profile">
				<img id="profile-img" src="https://emilcarlsson.se/assets/mikeross.png" class="online" alt="" />
			<span>{{username|parse}}</span>
		</div>
		<div id="deconnection">
			<p class="mdc-button mdc-button--raised"><a href="{%url 'deconnexion' %}"><span class="mdc-button__ripple"></span>Déconnexion</a></p>
{% if user.is_superuser %}
			<p class="mdc-button mdc-button--raised"><a href="/admin"><span class="mdc-button__ripple"></span>admin</a></p>
			{% endif %}
		</div>
		<p id="messagerie">Messagerie</p>
		<div id="all_chats">
			<ul>
			</ul>
		</div>
		<div id="bottom-bar">
			<button class="mdc-button mdc-button--raised" data-toggle="modal" data-target="#exampleModalCenter">
				<span class="mdc-button__ripple"></span>Créer un chat
			</button>
			<button id="settings" class="mdc-button mdc-button--raised"><i class="fa fa-cog fa-fw" aria-hidden="true"></i><span class="mdc-button__ripple"></span>Settings</button>
		</div>
	</nav>
	<section class="content">
		<div class="chat-profile">
			<span id="current_chat_name"></span>
			<i class="fas fa-thumbtack"></i>
		</div>
		<div class="messages">
			<ul id="chat-log"></ul>
		</div>
		<div class="message-input">
			<div class="wrap">
			<input type="text" id="chat-message-input" placeholder="Ecrivez votre message..." />
			<button class="submit" id="chat-message-submit"><i class="fa fa-paper-plane" aria-hidden="true"></i></button>
			</div>
		</div>
	</section>
	<nav id="sidepannel2">
		<div id="participants">
			<p>Participants</p>
		</div>
		<div id="list_participants">
			<ul id="all_participants"></ul>
		</div>
	</nav>
</main>
<div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document" style="left:0%">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalCenterTitle">Créer un chat</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      		<div class="modal-body">
				<span id="error_add" class="alert alert-danger invisible">Une/des adresses mails sont invalides !</span>
				<div class="container">
					<form action="" class="add_chat">
						<input type="text" id="chat_name" placeholder="Nom du chat" class="form-control"/>
						<input class="add_email_chat" type="email" id="emailField" placeholder="Email..." class="form-control"/>
						<ul class="all_email"></ul>
					</form>
				</div>
      		</div>
      		<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        		<button class="submit_add_chat btn btn-primary" type="submit">Créer</button>
				<button class="btn btn-info" id="public_chat">Public</button>
      		</div>
    </div>
  </div>
</div>
{% endblock %}
{% block script %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
<script src="{{STATIC_URL}}/static/messenger/js/momentlocale.js"></script>
<script >
	let contact_ul=document.querySelector('#all_chats').firstElementChild;
	let participants_ul=document.querySelector('#all_participants');
	const token="{{ request.session.token }}";
	const email={{email}}
	let wsprotocol;
  	location.protocol ==="http:" ? wsprotocol = "ws:" : wsprotocol="wss:";
  	const username = {{ username }}

  	const firstSocket=new WebSocket(wsprotocol+'//'
      					+ window.location.host
      					+ '/ws/messenger/accueil/');
  	firstSocket.onopen=(e)=>{console.log('first open')};
  	firstSocket.onmessage=function(e){
  		if(JSON.parse(e.data)==='fetch'){
  			AppendNewChat(token)
		}

	};
  	function AppendNewChat(token){
  		fetch(`/messenger-api/?email=${email}`,{
			method:'GET',
			credentials:'include',
			headers:{'Authorization':`Token ${token}`,'Content-Type': 'application/json'}
		}).then(resp=>{
			resp.json().then(data=>{
				if(data['detail']){console.error('Pas de chat!!')}
				else{
					let length_chat = data.length;
					let length_actual_chat = contact_ul.children.length;
					if(length_chat !== length_actual_chat) {
						for (let obj = length_actual_chat; obj < length_chat; obj++) {
							createChat(data[obj])
						}
					}
				}
			})
		})
	}
	function fetchParticipants(token,chat){
  		fetch(`/messenger-api/${chat}`,{
			method:'GET',
			credentials:'include',
			headers:{'Authorization':`Token ${token}`,'Content-Type': 'application/json'}
		}).then(resp=>{
			resp.json().then(data=>{
				for(const participant of data['participants']) {
					Participant(participant)
				}
			})
		})
	}
	let chatSocket;
  	function Participant(participant){
  		let c_li=document.createElement('li');
		c_li.classList="chat";
		let c_div=document.createElement('div');
		c_div.classList="wrap";
		let c_img=document.createElement('img');
		let c_name=document.createElement('span');
		c_name.classList="name";
		let c_pre=document.createElement('p');
		let first_name=participant.split('.')[0];
		let last_name=participant.split('.')[1].split('@')[0];
		c_pre.classList="preview";
		c_li.appendChild(c_div);
		c_img.src="https://emilcarlsson.se/assets/jonathansidwell.png";
		c_div.appendChild(c_img);
		c_name.textContent=`${first_name} ${last_name.toUpperCase()}`;
		c_div.appendChild(c_name);
		c_div.appendChild(c_pre);
		participants_ul.appendChild(c_li);
	}
	function createChat(contact){
		let c_li=document.createElement('li');
		c_li.classList="chat";
		let c_div=document.createElement('div');
		c_div.classList="wrap";
		let c_img=document.createElement('img');
		let c_name=document.createElement('span');
		c_name.classList="name";
		let c_pre=document.createElement('p');
		c_pre.classList="preview";
		c_li.appendChild(c_div);
		c_img.src="https://emilcarlsson.se/assets/jonathansidwell.png";
		c_div.appendChild(c_img);
		c_name.textContent=contact.name;
		c_div.appendChild(c_name);
		c_div.appendChild(c_pre);
		contact_ul.appendChild(c_li);
 
		c_li.addEventListener('click', (e)=>{
			 let current = document.querySelector('.activeChat');
			 let name =contact.id;
			 document.querySelector('#current_chat_name').innerHTML=`${contact.name}`;
			 participants_ul.innerHTML=""? fetchParticipants(token,name) :participants_ul.innerHTML="";fetchParticipants(token,name);
			 if(current!=null){
			 	current.classList.remove('activeChat');
			 	e.currentTarget.classList.add('activeChat')
			 }else{
			 	e.currentTarget.classList.add('activeChat')
			 }
    		if(chatSocket===undefined){
    			chatSocket=chatSocket=new WebSocket(wsprotocol+'//'
      					+ window.location.host
      					+ '/ws/messenger/'
      					+ contact.id
      					+ '/')

			}else if(chatSocket.url.includes(name)){

			}
			else{
    			chatSocket.close();
				chatSocket=new WebSocket(wsprotocol+'//'
      					+ window.location.host
      					+ '/ws/messenger/'
      					+ contact.id
      					+ '/')
			}

			chatSocket.onopen=function(e){
					fetchMessages();
			};
		  	chatSocket.onmessage = function(e) {
		      var data = JSON.parse(e.data);
		     if(data['command']==='messages'){
		     	document.querySelector('#chat-log').innerHTML!=="" ? document.querySelector('#chat-log').innerHTML="" :"";
		        for(let i=data['messages'].length-1;i>=0;i--){
		         createMessage(data['messages'][i])
		       }

		       document.querySelector('.messages').scrollTop=document.querySelector('.messages').scrollHeight;
		      }else if(data['command']==='new_message'){
		          createMessage(data['message']);
		          document.querySelector('.messages').scrollTop=document.querySelector('.messages').scrollHeight;
		        }
		  };

		  chatSocket.onclose = function(e) {
		      console.error('Chat socket closed unexpectedly');
		  };
		  function fetchMessages(){
		      chatSocket.send(JSON.stringify({'command':'fetch_user_messages','username':username,'id':contact.id}))
		  }
		  document.querySelector('#chat-message-submit').onclick = function(e) {
		      const messageInputDom = document.querySelector('#chat-message-input');
		      const message = messageInputDom.value;
		      if(message.length!==0){
		        chatSocket.send(JSON.stringify({
		          'message': message,
		          'command':'new_message',
		          'from':email,
		          'id':contact.id
		      }));
		      messageInputDom.value = '';
		      }
		      
		  };
		})

	}
  document.querySelector('#chat-message-input').onkeyup = function(e) {
      if (e.keyCode === 13) {  // enter, return
          document.querySelector('#chat-message-submit').click();
      }
  };
  function createMessage(data){
      let author=data['author'];
      let msgListTag=document.createElement('li');
      let imgTag=document.createElement('img');
      let authorTag=document.createElement('span');
      authorTag.textContent=author;
      let pTag=document.createElement('p');
      let schedule=moment((new Date(data.timestamp).getTime())).fromNow();
      pTag.innerHTML=`<span>${author}</span><small>${schedule}</small><p>${data.content}</p>`;
      imgTag.src="https://emilcarlsson.se/assets/mikeross.png";
      msgListTag.classList="sent";
      // if(author===username){
      //   msgListTag.classList="sent";
      // }else{
      //   msgListTag.classList="replies";
      // }
      msgListTag.appendChild(imgTag);
      msgListTag.appendChild(pTag);
      document.querySelector('#chat-log').appendChild(msgListTag);
  }

  
  AppendNewChat(token);
	let button_add_chat=document.querySelector('.submit_add_chat');
	let ul =document.querySelector('.all_email');
let i = document.querySelectorAll('.fa-times');
let input = document.querySelector('.add_email_chat');
let form = document.querySelector('.add_chat');
let modal=document.querySelector('#exampleModalCenter');
let publicButton=document.querySelector('#public_chat');
form.onsubmit=(e)=>e.preventDefault();

input.onkeyup = function(e) {
      if (e.keyCode === 13 && e.target.validity.typeMismatch===false && e.target.value!=="") {  // enter, return
          construct(e.target.value);
          e.target.value=""
      }
  };

 function construct(value){
 	let li=document.createElement('li');
 	li.classList="chips";
 	let i = document.createElement('i');
 	let span = document.createElement('span');
 	i.classList='fas fa-times';
 	Event(i,ul);
 	li.appendChild(i);
 	span.textContent=value;
 	li.appendChild(span);
 	ul.appendChild(li)
 }

 function Event(i,parent){
 	i.addEventListener('click',(e)=>{
		const currentElement=e.currentTarget;
		parent.removeChild(currentElement.parentElement)
	})
 }
 //création chat public (doit être réglementé)
 publicButton.addEventListener('click',()=> {
	 if (document.querySelector('#chat_name').value !== "") {
		 fetch('/messenger-api/create/', {
			 method: 'POST',
			 credentials: 'include',
			 headers: {'Authorization': `Token ${token}`, 'Content-Type': 'application/json'},
			 body: JSON.stringify({
				 messages: [],
				 participants: ['all'],
				 name: document.querySelector('#chat_name').value
			 })
		 })
				 .then((response) => {
					 if (response.ok) {
						 firstSocket.send(JSON.stringify({
							 'command': 'fetch_channels',
							 'id': 'new'
						 }));
						 $('#exampleModalCenter').modal('hide');
					 } else {
						 throw new Error('Un utilisateur n\'exise pas!')
					 }
				 }).catch(document.querySelector('#error_add').classList.remove('invisible'))
	 }
 });
 button_add_chat.addEventListener('click',()=>{
 	const participants=[];
 	const allMail = document.querySelectorAll('.chips');
 	allMail.forEach((chips)=>{participants.push(chips.textContent)});
 	participants.includes(`${email}`) ? "" : participants.push(`${email}`);
	 if(participants.length>1 && document.querySelector('#chat_name').value!=="" ){
	 	fetch('/messenger-api/create/',{
	 		method:'POST',
			credentials:'include',
			headers:{'Authorization':`Token ${token}`,'Content-Type': 'application/json'},
			body:JSON.stringify({messages:[],participants:participants,name:document.querySelector('#chat_name').value})
		}).then((response)=>{
			if(response.ok){
				document.querySelector('#error_add').textContent='création d\'un nouveau channel...';
				firstSocket.send(JSON.stringify({
		          'command':'fetch_channels',
		          'id':'new'
		      }));
				$('#exampleModalCenter').modal('hide');
			}
			else{throw new Error('Un utilisateur n\'exise pas!')}
		}
			).catch(document.querySelector('#error_add').classList.remove('invisible'))
	 }
 });
	$('#exampleModalCenter').on('hidden.bs.modal',(e)=>{
		input.value="";
		document.querySelector('#error_add').classList.contains('invisible')? "":document.querySelector('#error_add').classList.add('invisible')
	})
</script>
<script>
</script>
{%endblock%}
